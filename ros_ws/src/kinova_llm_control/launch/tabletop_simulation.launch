<?xml version="1.0"?>
<!--
  Tabletop Pick-and-Place Simulation

  Layout:
  - Table: 1.2m x 0.8m at height 0.75m
  - Robot: On one end of table (near edge)
  - Camera: On opposite end, looking across the table
  - Objects: Colored balls scattered on the table

  Usage:
    roslaunch kinova_llm_control tabletop_simulation.launch
-->
<launch>
  <!-- Robot Arguments -->
  <arg name="kinova_robotType" default="m1n6s300"/>
  <arg name="kinova_robotName" default="$(arg kinova_robotType)"/>
  <arg name="use_trajectory_controller" default="true"/>
  <arg name="paused" default="false"/>
  <arg name="gui" default="true"/>

  <!-- LLM Configuration -->
  <arg name="project_id" default="account-pocs"/>
  <arg name="location" default="us-central1"/>
  <arg name="model_name" default="gemini-2.0-flash"/>

  <!-- Camera position (far end of table, sitting on table surface looking back) -->
  <arg name="camera_x" default="0.95"/>
  <arg name="camera_y" default="0.0"/>
  <arg name="camera_z" default="0.765"/>

  <!-- ==================== Gazebo with Kinova arm ==================== -->
  <!-- IMPORTANT: kinova_gazebo/robot_launch.launch does NOT accept 'world' argument -->
  <!-- Only pass the arguments it actually accepts -->
  <include file="$(find kinova_gazebo)/launch/robot_launch.launch" pass_all_args="false">
    <arg name="kinova_robotType" value="$(arg kinova_robotType)"/>
    <arg name="kinova_robotName" value="$(arg kinova_robotName)"/>
    <arg name="use_trajectory_controller" value="$(arg use_trajectory_controller)"/>
    <arg name="paused" value="$(arg paused)"/>
    <arg name="gui" value="$(arg gui)"/>
  </include>

  <!-- ==================== Spawn Table and Objects ==================== -->
  <!-- Spawn after robot is loaded (delay to ensure Gazebo is ready) -->
  <node name="spawn_table" pkg="gazebo_ros" type="spawn_model" respawn="false" output="screen"
        args="-sdf -file $(find kinova_llm_control)/models/table/model.sdf -model table -x 0.5 -y 0 -z 0"
        launch-prefix="bash -c 'sleep 3; $0 $@'"/>

  <node name="spawn_red_ball" pkg="gazebo_ros" type="spawn_model" respawn="false" output="screen"
        args="-sdf -file $(find kinova_llm_control)/models/ball_red/model.sdf -model red_ball -x 0.4 -y 0.15 -z 0.80"
        launch-prefix="bash -c 'sleep 4; $0 $@'"/>

  <node name="spawn_green_ball" pkg="gazebo_ros" type="spawn_model" respawn="false" output="screen"
        args="-sdf -file $(find kinova_llm_control)/models/ball_green/model.sdf -model green_ball -x 0.5 -y -0.1 -z 0.80"
        launch-prefix="bash -c 'sleep 4; $0 $@'"/>

  <node name="spawn_blue_ball" pkg="gazebo_ros" type="spawn_model" respawn="false" output="screen"
        args="-sdf -file $(find kinova_llm_control)/models/ball_blue/model.sdf -model blue_ball -x 0.6 -y 0.2 -z 0.80"
        launch-prefix="bash -c 'sleep 4; $0 $@'"/>

  <!-- ==================== RealSense D435 Camera ==================== -->
  <param name="camera_description"
         command="$(find xacro)/xacro $(find kinova_llm_control)/urdf/camera_stand.urdf.xacro"/>

  <node name="spawn_camera" pkg="gazebo_ros" type="spawn_model" respawn="false" output="screen"
        args="-urdf -param camera_description -model camera_stand
              -x $(arg camera_x) -y $(arg camera_y) -z $(arg camera_z)"
        launch-prefix="bash -c 'sleep 2; $0 $@'"/>

  <!-- ==================== MoveIt Motion Planning ==================== -->
  <!-- Load planning context (URDF/SRDF) - this is safe and doesn't launch Gazebo -->
  <include file="$(find m1n6s300_moveit_config)/launch/planning_context.launch">
    <arg name="load_robot_description" value="false"/>
  </include>

  <!-- Start move_group node directly (avoiding any problematic launch includes) -->
  <node name="move_group" pkg="moveit_ros_move_group" type="move_group" respawn="false" output="screen">
    <param name="allow_trajectory_execution" value="true"/>
    <param name="max_safe_path_cost" value="1"/>
    <param name="jiggle_fraction" value="0.05"/>
    <param name="planning_scene_monitor/publish_planning_scene" value="true"/>
    <param name="planning_scene_monitor/publish_geometry_updates" value="true"/>
    <param name="planning_scene_monitor/publish_state_updates" value="true"/>
    <param name="planning_scene_monitor/publish_transforms_updates" value="true"/>
  </node>

  <!-- ==================== LLM Controller ==================== -->
  <node name="llm_controller"
        pkg="kinova_llm_control"
        type="llm_controller_wrapper.sh"
        output="screen"
        respawn="false">
    <param name="project_id" value="$(arg project_id)"/>
    <param name="location" value="$(arg location)"/>
    <param name="model_name" value="$(arg model_name)"/>
  </node>

  <!-- ==================== Command Interface ==================== -->
  <node name="command_interface"
        pkg="kinova_llm_control"
        type="command_interface.py"
        output="screen"
        launch-prefix="xterm -title 'Kinova LLM Commands' -e"/>

</launch>
